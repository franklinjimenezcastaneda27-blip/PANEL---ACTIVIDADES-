<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, 
  onSnapshot, query, where, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1ZtWRXaR89lTkFTKGaqWo3cyfBAv5Cc4",
  authDomain: "calendario-de-actividade-3b553.firebaseapp.com",
  projectId: "calendario-de-actividade-3b553",
  storageBucket: "calendario-de-actividade-3b553.firebasestorage.app",
  messagingSenderId: "330806785515",
  appId: "1:330806785515:web:3448d1f0ffc83422c795ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const eventsRef = collection(db, "eventos");

let currentDate = new Date();
let selectedDate = null;
let eventsArray = [];
let currentEventId = null;

const calendarGrid = document.getElementById("calendar");
const monthDisplay = document.getElementById("currentMonthDisplay");

function loadEvents() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  const q = query(
    eventsRef,
    where("year", "==", year),
    where("month", "==", month),
    orderBy("time")
  );

  onSnapshot(q, (snapshot) => {
    eventsArray = [];
    snapshot.forEach(docSnap => eventsArray.push({ id: docSnap.id, ...docSnap.data() }));
    renderCalendar();
  });
}

function renderCalendar() {
  calendarGrid.innerHTML = "";
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  monthDisplay.textContent = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(currentDate);

  const firstDayIndex = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDayIndex; i++) {
    const emptyDiv = document.createElement("div");
    emptyDiv.className = "day empty";
    calendarGrid.appendChild(emptyDiv);
  }

  const filterVal = document.getElementById("filterCategory").value;

  for (let day = 1; day <= daysInMonth; day++) {
    const dayDiv = document.createElement("div");
    dayDiv.className = "day";
    dayDiv.style.overflowY = "auto";

    const today = new Date();
    if(day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) 
      dayDiv.classList.add("today");

    dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
    
    const currentDayStr = new Date(year, month, day).toDateString();

    const dayEvents = eventsArray.filter(e => {
      const isDate = new Date(e.date).toDateString() === currentDayStr;
      const isType = filterVal === "all" || e.type === filterVal;
      return isDate && isType;
    });

    const visibleEvents = dayEvents.slice(0,3);

    visibleEvents.forEach(evt => {
      const evtDiv = document.createElement("div");
      evtDiv.className = "event";
      if(evt.completed) evtDiv.classList.add("completed");
      evtDiv.style.backgroundColor = evt.completed ? "#adb5bd" : getColor(evt.type);
      evtDiv.innerHTML = `${evt.time} ${evt.title}`;
      evtDiv.onclick = (e) => { e.stopPropagation(); openActionModal(evt); };
      dayDiv.appendChild(evtDiv);
    });

    if(dayEvents.length > 3){
      const more = document.createElement("div");
      more.style.fontSize = "9px";
      more.textContent = `+ ${dayEvents.length - 3} más...`;
      dayDiv.appendChild(more);
    }

    dayDiv.onclick = () => openModal(year, month, day);
    calendarGrid.appendChild(dayDiv);
  }
}

function getColor(type){
  switch(type){
    case "cobranza_comunal": return "#fa5252";
    case "cobranza_individual": return "#fd7e14";
    case "visita": return "#228be6";
    case "desembolso": return "#40c057";
    case "reunion": return "#fab005";
    default: return "#868e96";
  }
}

window.changeMonth = (step) => { 
  currentDate.setMonth(currentDate.getMonth() + step); 
  loadEvents();
}

window.applyFilter = () => renderCalendar();

function openModal(year, month, day) {
  selectedDate = new Date(year, month, day);
  document.getElementById("modal").style.display = "flex";
}

function openActionModal(evt) {
  currentEventId = evt.id;
  document.getElementById("actionTitle").textContent = evt.title;
  document.getElementById("actionDetails").innerHTML = `
    <b>Resp:</b> ${evt.responsible || "-"}<br>
    <b>Hora:</b> ${evt.time}<br>
    <b>Ubicación:</b> ${evt.location ? `<a href="${evt.location}" target="_blank">Ver</a>` : "-"}
  `;
  document.getElementById("modalActions").style.display = "flex";
}

window.closeModal = (id) => document.getElementById(id).style.display = "none";

window.saveEvent = async function() {
  const title = document.getElementById("eventTitle").value;
  const responsible = document.getElementById("eventResponsible").value;
  const time = document.getElementById("eventTime").value;
  const type = document.getElementById("eventType").value;
  const location = document.getElementById("eventLocation")?.value || "";

  if (!title) return;

  const conflict = eventsArray.find(e => 
    new Date(e.date).toDateString() === selectedDate.toDateString() &&
    e.time === time &&
    e.responsible === responsible
  );

  if(conflict){
    alert("⚠️ El responsable ya tiene actividad a esa hora.");
    return;
  }

  await addDoc(eventsRef, { 
    title, 
    responsible, 
    time, 
    type, 
    location,
    date: selectedDate.toISOString(),
    year: selectedDate.getFullYear(),
    month: selectedDate.getMonth(),
    completed: false,
    createdAt: serverTimestamp()
  });

  closeModal('modal');
}

window.toggleComplete = async function() {
  const evt = eventsArray.find(e => e.id === currentEventId);
  await updateDoc(doc(db, "eventos", currentEventId), { completed: !evt.completed });
  closeModal('modalActions');
}

window.deleteEvent = async function() {
  if(confirm("¿Eliminar?")) { 
    await deleteDoc(doc(db, "eventos", currentEventId)); 
    closeModal('modalActions'); 
  }
}

window.showStats = () => {
  const total = eventsArray.length;
  const completed = eventsArray.filter(e => e.completed).length;
  const percent = total ? Math.round((completed/total)*100) : 0;

  const byType = {};
  eventsArray.forEach(e => {
    byType[e.type] = (byType[e.type] || 0) + 1;
  });

  const container = document.getElementById("statsContainer");
  container.innerHTML = `
    <div class="stat-box"><span class="stat-number">${total}</span><small>Total</small></div>
    <div class="stat-box"><span class="stat-number">${completed}</span><small>Listas</small></div>
    <div class="stat-box"><span class="stat-number">${percent}%</span><small>Cumplimiento</small></div>
  `;

  for(const type in byType){
    container.innerHTML += `
      <div class="stat-box">
        <span class="stat-number">${byType[type]}</span>
        <small>${type}</small>
      </div>
    `;
  }

  document.getElementById("modalStats").style.display = "flex";
}

loadEvents();
</script>
